<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>OURBUS — Nosso Ônibus</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ff9020"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg:#f6f7fb; --accent:#ff9020; --nav:#0b4c7b; --card:#ffffff; --muted:#6b7280; --text:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Roboto,Arial;color:var(--text);background:var(--bg);-webkit-font-smoothing:antialiased}
    .app{max-width:980px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
    .topbar{display:flex;align-items:center;gap:12px;padding:10px 14px;background:linear-gradient(90deg,var(--accent),#ffb36b);color:#fff;border-bottom-left-radius:14px;border-bottom-right-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.12)}
    .brand{font-weight:800;font-size:18px;letter-spacing:.6px}
    .btn{background:#fff;color:var(--nav);border-radius:10px;padding:8px 12px;font-weight:700;border:0;cursor:pointer}
    .content{display:flex;flex:1;gap:14px;padding:16px}
    .sidebar{width:260px;background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 24px rgba(15,23,42,.06);display:flex;flex-direction:column;gap:10px}
    .main{flex:1;display:flex;flex-direction:column;gap:12px}
    .map-card{background:var(--card);border-radius:16px;overflow:hidden;box-shadow:0 12px 30px rgba(2,6,23,.08)}
    #map{height:64vh;min-height:420px;width:100%}
    .map-actions{display:flex;gap:8px;padding:10px;align-items:center;justify-content:space-between}
    .pill{border-radius:999px;padding:10px 14px;border:0;cursor:pointer;font-weight:800}
    .pill.primary{background:var(--accent);color:#fff}
    .pill.ghost{background:#fff;color:var(--nav);border:1px solid #e6e9ef}
    .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(2,6,23,.06)}
    .muted{color:var(--muted);font-size:14px}
    .legend{display:flex;gap:12px;align-items:center}
    .legend .dot{width:12px;height:12px;border-radius:50%}
    .dot-bus{background:var(--accent)} .dot-wait{background:#111}
    @media (max-width:920px){ .content{padding:12px} .sidebar{display:none} #map{height:66vh} }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">OURBUS</div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="signBtn" class="btn">Entrar</button>
        <img id="avatarTop" alt="avatar" style="display:none;width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.6)" />
      </div>
    </div>

    <div class="content">
      <aside class="sidebar">
        <div style="font-weight:800">Menu</div>
        <div class="card">
          <div style="font-weight:700">Horários</div>
          <ul id="scheduleList" style="padding-left:16px;margin:6px 0 0;color:var(--muted)"></ul>
        </div>
      </aside>

      <div class="main">
        <div class="map-card">
          <div id="map"></div>
          <div class="map-actions">
            <div style="display:flex;gap:8px;align-items:center">
              <select id="route" class="pill ghost">
                <option value="Interno">Interno (dentro da sede)</option>
                <option value="Intercampi">Intercampi (Sede ↔ CI/CTDR)</option>
              </select>
              <button id="shareBtn" class="pill primary">Estou no ônibus</button>
              <button id="waitBtn" class="pill ghost">ESTOU CHEGANDO</button>
            </div>
            <div class="legend">
              <div class="dot dot-bus"></div><div class="muted">Ônibus</div>
              <div class="dot dot-wait"></div><div class="muted">Pedidos</div>
            </div>
          </div>
        </div>

        <div class="card" style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800">Status: <span id="status">offline</span></div>
            <div class="muted">Usuário: <span id="uid">-</span></div>
            <div class="muted" id="modeInfo">Modo: Demo local</div>
          </div>
          <div>
            <button id="clearTrail" class="pill ghost">Limpar trilha</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Sininho simples
    function playDing(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.value=0; o.start(); g.gain.linearRampToValueAtTime(0.07, ctx.currentTime + 0.01); o.frequency.linearRampToValueAtTime(1320, ctx.currentTime + 0.12); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5); setTimeout(()=>{ o.stop(); ctx.close(); }, 600);}catch(e){} }
  </script>

  <script type="module">
    // =======================
    // CONFIGURAÇÃO / MODOS
    // =======================
    // Modo demo funciona sem Firebase (simula um ônibus e pedidos locais)
    const USE_FIREBASE = true; // mude para true quando preencher firebaseConfig

    // Se for usar Firebase, preencha:
    const firebaseConfig = {
      apiKey: "AIzaSyDh1wQX2Mu-AdJ841kMS6t1tq1qhI90yfA",
      authDomain: "ourbus-a9ef4.firebaseapp.com",
      projectId: "ourbus-a9ef4",
      storageBucket: "ourbus-a9ef4.appspot.com",
      messagingSenderId: "612533394400",
      appId: "1:612533394400:web:52f2b08b3c887b8ea0a985",
      measurementId: "G-V2MTHGSY45"
    };

    // =======================
    // UI REFS
    // =======================
    const signBtn = document.getElementById('signBtn');
    const avatarTop = document.getElementById('avatarTop');
    const statusEl = document.getElementById('status');
    const uidEl = document.getElementById('uid');
    const modeInfo = document.getElementById('modeInfo');
    const routeSel = document.getElementById('route');
    const shareBtn = document.getElementById('shareBtn');
    const waitBtn = document.getElementById('waitBtn');
    const scheduleList = document.getElementById('scheduleList');
    const clearTrailBtn = document.getElementById('clearTrail');

    // =======================
    // MAPA
    // =======================
    const map = L.map('map', { zoomControl:true, preferCanvas:true });
    const defaultPos = { lat: -7.135742, lng: -34.845412 }; // UFPB — Sede João Pessoa
    map.setView(defaultPos, 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap' }).addTo(map);

    const busLayer = L.layerGroup().addTo(map);
    const waitLayer = L.layerGroup().addTo(map);
    const trailLayer = L.layerGroup().addTo(map);
    let busPolyline = L.polyline([], { color: '#0ea5e9', weight: 5, opacity: 0.95 }).addTo(trailLayer);
    let busMarker = null;

    function busIcon(){
      const svg = encodeURIComponent(`<svg viewBox="0 0 24 24" width="26" height="26" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="5" width="18" height="11" rx="2" stroke="${encodeURIComponent('#ff9020')}" stroke-width="1.6" fill="#fff"/><circle cx="7" cy="18" r="1.4" fill="${encodeURIComponent('#111')}"/><circle cx="17" cy="18" r="1.4" fill="${encodeURIComponent('#111')}"/></svg>`);
      const html = `<div style="width:46px;height:46px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(180deg,#fff,#f8fafc);border:3px solid #ff9020;box-shadow:0 6px 18px rgba(0,0,0,.18)"><img src="data:image/svg+xml;utf8,${svg}" style="width:26px;height:26px" /></div>`;
      return L.divIcon({ html, className:'', iconSize:[46,46], iconAnchor:[23,23] });
    }
    function avatarIcon(url, size=44){
      const html = `<div style="width:${size}px;height:${size}px;border-radius:50%;overflow:hidden;border:3px solid #fff;box-shadow:0 6px 14px rgba(0,0,0,.18)">${url?`<img src="${url}" alt="avatar" style="width:100%;height:100%;object-fit:cover"/>`:''}</div>`;
      return L.divIcon({ html, className:'', iconSize:[size,size], iconAnchor:[size/2,size/2] });
    }

    // =======================
    // HORÁRIOS
    // =======================
    const schedules = [
      { route: 'Interno', time: '06:40', note:'DUAS VOLTAS APENAS DENTRO DA SEDE' },
      { route: 'Intercampi', time: '07:20', note:'SEDE → CI/CTDR' },
      { route: 'Intercampi', time: '08:00', note:'CI/CTDR → SEDE (UMA VOLTA)' },
      { route: 'Interno', time: '09:20', note:'DUAS VOLTAS' },
      { route: 'Interno', time: '10:20', note:'DUAS VOLTAS' },
      { route: 'Interno', time: '11:20', note:'DUAS VOLTAS' },
      { route: 'Intercampi', time: '12:20', note:'SEDE → CI/CTDR' },
      { route: 'Intercampi', time: '13:00', note:'CI/CTDR → SEDE (UMA VOLTA)' },
      { route: 'Interno', time: '14:20', note:'DUAS VOLTAS' },
      { route: 'Interno', time: '15:20', note:'DUAS VOLTAS' },
      { route: 'Interno', time: '16:20', note:'DUAS VOLTAS' },
      { route: 'Interno', time: '17:20', note:'DUAS VOLTAS' },
      { route: 'Intercampi', time: '18:20', note:'SEDE → CI/CTDR' },
      { route: 'Intercampi', time: '19:00', note:'CI/CTDR → SEDE (UMA VOLTA)' },
      { route: 'Interno', time: '20:20', note:'UMA VOLTA' },
      { route: 'Intercampi', time: '21:30', note:'SEDE → CI/CTDR' },
      { route: 'Intercampi', time: '22:00', note:'CI/CTDR → SEDE (UMA VOLTA)' }
    ];
    function renderScheduleUI(){
      scheduleList.innerHTML = schedules.filter(s=>s.route===routeSel.value).map(s=>`<li>${s.time} — ${s.note}</li>`).join('');
    }
    renderScheduleUI();
    routeSel.addEventListener('change', renderScheduleUI);

    // =======================
    // AUTH/USUÁRIO
    // =======================
    let currentUser = null; // { uid, name, photoURL }

    async function demoSign(){
      currentUser = { uid: 'demo-'+Math.random().toString(36).slice(2,8), name: 'Usuário Demo', photoURL: '' };
      statusEl.textContent = 'online';
      uidEl.textContent = currentUser.name;
      avatarTop.style.display = 'none';
    }

    if(!USE_FIREBASE){
      modeInfo.textContent = 'Modo: Demo local (sem Firebase)';
      signBtn.textContent = 'Entrar (demo)';
      signBtn.addEventListener('click', demoSign);
    } else {
      modeInfo.textContent = 'Modo: Online (Firebase)';
      // Carrega Firebase modular dinamicamente
      const [{ initializeApp }, { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut }, { getFirestore, collection, addDoc, setDoc, doc, serverTimestamp, onSnapshot, query, orderBy, limit, deleteDoc }] = await Promise.all([
        import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js'),
        import('https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js'),
        import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js')
      ]);
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const provider = new GoogleAuthProvider();

      signBtn.addEventListener('click', async ()=>{
        try{ await signInWithPopup(auth, provider); }catch(e){ alert('Erro login: '+e.message); }
      });
      onAuthStateChanged(auth, user=>{
        currentUser = user ? { uid:user.uid, name:user.displayName||user.email||'Usuário', photoURL:user.photoURL||'' } : null;
        statusEl.textContent = user ? 'online' : 'offline';
        uidEl.textContent = user ? (currentUser.name) : '-';
        if(user && user.photoURL){ avatarTop.src=user.photoURL; avatarTop.style.display='inline-block'; signBtn.style.display='none'; } else { avatarTop.style.display='none'; signBtn.style.display='inline-flex'; }
      });

      // Firestore listeners
      onSnapshot(query(collection(db,'bus_pings'), orderBy('ts','asc'), limit(1000)), snap=>{
        const pts = [];
        snap.docs.forEach(d=>{ const x=d.data(); if(x.route!==routeSel.value) return; pts.push([x.lat,x.lng]); });
        busPolyline.setLatLngs(pts);
        if(pts.length){
          const last = pts[pts.length-1];
          if(!busMarker) busMarker = L.marker(last, { icon: busIcon() }).addTo(busLayer); else busMarker.setLatLng(last);
        } else { if(busMarker){ busLayer.removeLayer(busMarker); busMarker=null; } }
      });

      onSnapshot(query(collection(db,'wait_requests'), orderBy('ts','desc'), limit(200)), snap=>{
        waitLayer.clearLayers();
        const cutoff = Date.now() - 1000*60*15;
        snap.docs.forEach(d=>{
          const x=d.data(); if(x.route!==routeSel.value) return; const t=x.ts?.toMillis?.()??0; if(t < cutoff) return;
          const m = L.marker([x.lat,x.lng], { icon: avatarIcon(x.photoURL||'', 44) }).bindPopup(`<b>${(x.name||'Aluno')}</b><br/>Pedido: Espera eu!`).addTo(waitLayer);
          if(busPolyline.getLatLngs().length){ const bp = busPolyline.getLatLngs().slice(-1)[0]; L.polyline([[x.lat,x.lng],[bp.lat,bp.lng]], { color:'#111', weight:3, dashArray:'8 6', opacity:.8 }).addTo(waitLayer); }
        });
      });

      // Ações que escrevem
      async function startSharingAsBus(){
        if(!currentUser) return alert('Faça login antes.');
        if(!('geolocation' in navigator)) return alert('Geolocalização não suportada');
        navigator.geolocation.watchPosition(async pos=>{
          const { latitude:lat, longitude:lng, accuracy } = pos.coords;
          try{
            const ref = collection(db,'bus_pings');
            const { serverTimestamp, addDoc } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
            await addDoc(ref, { uid: currentUser.uid, name: currentUser.name, photoURL: currentUser.photoURL||null, route: routeSel.value, lat, lng, accuracy, ts: serverTimestamp() });
          }catch(e){ console.error(e); }
        }, err=>console.warn(err), { enableHighAccuracy:true, maximumAge:2000, timeout:15000 });
      }
      async function startWaitRequest(){
        if(!currentUser) return alert('Faça login antes.');
        if(!('geolocation' in navigator)) return alert('Geolocalização não suportada');
        const { setDoc, doc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
        const id = `${currentUser.uid}_${routeSel.value}`;
        const ref = doc(db,'wait_requests', id);
        navigator.geolocation.watchPosition(async pos=>{
          const { latitude:lat, longitude:lng, accuracy } = pos.coords;
          try{ await setDoc(ref, { uid: currentUser.uid, name: currentUser.name, photoURL: currentUser.photoURL||null, route: routeSel.value, lat, lng, accuracy, ts: serverTimestamp() }, { merge:true }); }catch(e){ console.error(e); }
        }, err=>console.warn(err), { enableHighAccuracy:true, maximumAge:2000, timeout:15000 });
      }

      // Liga botões (online)
      shareBtn.addEventListener('click', startSharingAsBus);
      waitBtn.addEventListener('click', startWaitRequest);
    }

    // =======================
    // MODO DEMO (sem Firebase)
    // =======================
    let demoTimer = null; let theta = 0; let demoWait = null;
    function startDemoBus(){
      if(demoTimer) return;
      const center = defaultPos; const R = 0.01; // ~1km
      demoTimer = setInterval(()=>{
        theta += 0.04; const lat = center.lat + R*Math.sin(theta); const lng = center.lng + R*Math.cos(theta);
        const pts = [...busPolyline.getLatLngs(), [lat,lng]]; if(pts.length>500) pts.shift(); busPolyline.setLatLngs(pts);
        if(!busMarker) busMarker = L.marker([lat,lng], { icon: busIcon() }).addTo(busLayer); else busMarker.setLatLng([lat,lng]);
      }, 400);
    }
    function stopDemoBus(){ if(demoTimer){ clearInterval(demoTimer); demoTimer=null; } }

    function addDemoWait(){
      if(demoWait){ demoWait.remove(); demoWait=null; }
      const p = map.getCenter();
      demoWait = L.marker([p.lat + (Math.random()-0.5)*0.006, p.lng + (Math.random()-0.5)*0.006], { icon: avatarIcon('', 44) })
        .bindPopup('<b>Aluno Demo</b><br/>Pedido: Espera eu!').addTo(waitLayer);
      playDing();
    }

    // Liga botões no modo demo
    if(!USE_FIREBASE){
      shareBtn.addEventListener('click', ()=>{ if(!currentUser) return alert('Clique em Entrar (demo) primeiro.'); startDemoBus(); });
      waitBtn.addEventListener('click', ()=>{ if(!currentUser) return alert('Clique em Entrar (demo) primeiro.'); addDemoWait(); });
    }

    // Utilidades
    clearTrailBtn.addEventListener('click', ()=>{ busPolyline.setLatLngs([]); });

    // PWA SW
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
  </script>
</body>
</html>
