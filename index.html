<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>OURBUS — Nosso Ônibus</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ff9020"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Firebase v10 modular -->
  <script type="module" crossorigin src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js"></script>
  <script type="module" crossorigin src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js"></script>
  <script type="module" crossorigin src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js"></script>

  <style>
    :root{
      --bg:#f3f6f9;
      --accent:#ff9020;
      --nav:#0b4c7b;
      --card:#ffffff;
      --muted:#6b7280;
      --success:#2dd4bf;
      --text:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Roboto,Arial;color:var(--text);background:var(--bg);-webkit-font-smoothing:antialiased}
    /* App-like frame */
    .app{
      max-width:980px;margin:0 auto;height:100vh;display:flex;flex-direction:column;background:transparent;
    }
    /* Top bar */
    .topbar{display:flex;align-items:center;gap:12px;padding:10px 14px;background:linear-gradient(90deg,var(--accent),#ffb36b);color:#fff;border-bottom-left-radius:14px;border-bottom-right-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.12)}
    .hamb{width:40px;height:40px;border-radius:10px;background:rgba(0,0,0,.12);display:grid;place-items:center;cursor:pointer}
    .brand{font-weight:800;font-size:18px;letter-spacing:.6px}
    .top-right{margin-left:auto;display:flex;gap:8px;align-items:center}
    .avatar-top{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.6)}
    .btn{background:#fff;color:var(--nav);border-radius:10px;padding:8px 12px;font-weight:700;border:0;cursor:pointer}
    /* Layout content */
    .content{display:flex;flex:1;gap:14px;padding:16px}
    /* Sidebar */
    .sidebar{width:260px;background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 24px rgba(15,23,42,.06);display:flex;flex-direction:column;gap:10px}
    .sidebar .title{font-weight:800}
    .nav-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px}
    .nav-list button{background:transparent;border:0;padding:10px;border-radius:8px;text-align:left;cursor:pointer;font-weight:600}
    .main{flex:1;display:flex;flex-direction:column;gap:12px}
    /* Map card */
    .map-card{background:var(--card);border-radius:16px;padding:0;overflow:hidden;box-shadow:0 12px 30px rgba(2,6,23,.08)}
    #map{height:64vh;min-height:420px;width:100%}
    .map-actions{display:flex;gap:8px;padding:10px;align-items:center}
    .pill{border-radius:999px;padding:10px 14px;border:0;cursor:pointer;font-weight:800}
    .pill.primary{background:var(--accent);color:#fff}
    .pill.ghost{background:#fff;color:var(--nav);border:1px solid #e6e9ef}
    /* schedule card */
    .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(2,6,23,.06)}
    .muted{color:var(--muted);font-size:14px}
    /* marker avatar CSS (for custom DivIcon) */
    .avatar-marker{width:44px;height:44px;border-radius:50%;overflow:hidden;border:3px solid #fff;box-shadow:0 6px 14px rgba(0,0,0,.18)}
    .avatar-marker img{width:100%;height:100%;object-fit:cover;display:block}
    /* bus icon (circle with svg) */
    .bus-marker{width:46px;height:46px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(180deg,#fff,#f8fafc);border:3px solid var(--accent);box-shadow:0 6px 18px rgba(0,0,0,.18)}
    .legend{display:flex;gap:12px;align-items:center}
    .legend .dot{width:12px;height:12px;border-radius:50%}
    .dot-bus{background:var(--accent)} .dot-wait{background:#ff9020}
    /* responsive: hide sidebar on small screens */
    @media (max-width:920px){
      .content{padding:12px}
      .sidebar{display:none}
      .map-card #map{height:66vh}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="hamb" id="menuBtn" title="Menu">☰</div>
      <div class="brand">OURBUS</div>
      <div class="top-right">
        <button id="signBtn" class="btn">Entrar com Google</button>
        <img id="avatarTop" class="avatar-top" src="" alt="avatar" style="display:none"/>
      </div>
    </div>

    <div class="content">
      <aside class="sidebar" id="sidebar">
        <div class="title">Menu</div>
        <ul class="nav-list">
          <li><button id="viewMapBtn">Mapa</button></li>
          <li><button id="viewScheduleBtn">Horários</button></li>
          <li><button id="viewProfileBtn">Perfil</button></li>
        </ul>
        <div style="margin-top:auto" class="card">
          <div style="font-weight:700">Horários (resumo)</div>
          <ul id="scheduleList" style="padding-left:16px;margin:6px 0 0;color:var(--muted)"></ul>
        </div>
      </aside>

      <div class="main">
        <div class="map-card">
          <div id="map"></div>
          <div class="map-actions" style="justify-content:space-between">
            <div style="display:flex;gap:8px;align-items:center">
              <select id="route" class="pill ghost">
                <option value="Interno">Interno (dentro da sede)</option>
                <option value="Intercampi">Intercampi (Sede ↔ CI/CTDR)</option>
              </select>
              <button id="shareBtn" class="pill primary">Estou no ônibus</button>
              <button id="waitBtn" class="pill" style="background:#fff;border:1px solid #eee">ESTOU CHEGANDO</button>
            </div>
            <div class="legend" style="padding-right:10px">
              <div class="dot dot-bus"></div><div class="muted">Ônibus</div>
              <div class="dot dot-wait"></div><div class="muted">Pedidos</div>
            </div>
          </div>
        </div>

        <div class="card" style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800">Status: <span id="status">offline</span></div>
            <div class="muted">Usuário: <span id="uid">-</span></div>
          </div>
          <div>
            <button id="clearTrail" class="pill ghost">Limpar trilha</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- audio notification generated by WebAudio (no file required) -->
  <script>
    // helper to play a short "uber-like" notification (synth)
    function playDing(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 880;
        o.connect(g);
        g.connect(ctx.destination);
        g.gain.value = 0;
        o.start();
        g.gain.linearRampToValueAtTime(0.07, ctx.currentTime + 0.01);
        o.frequency.linearRampToValueAtTime(1320, ctx.currentTime + 0.12);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
        setTimeout(()=>{ o.stop(); ctx.close(); }, 600);
      }catch(e){ /* ignore autoplay blocks */ }
    }
  </script>

  <script type="module">
    // ---------------------------
    // Firebase config (use o seu)
    // ---------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDh1wQX2Mu-AdJ841kMS6t1tq1qhI90yfA",
      authDomain: "ourbus-a9ef4.firebaseapp.com",
      projectId: "ourbus-a9ef4",
      storageBucket: "ourbus-a9ef4.appspot.com", // corrigido
      messagingSenderId: "612533394400",
      appId: "1:612533394400:web:52f2b08b3c887b8ea0a985"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, addDoc, setDoc, doc, serverTimestamp, onSnapshot, query, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // UI refs
    const menuBtn = document.getElementById('menuBtn');
    const sidebar = document.getElementById('sidebar');
    const signBtn = document.getElementById('signBtn');
    const avatarTop = document.getElementById('avatarTop');
    const statusEl = document.getElementById('status');
    const uidEl = document.getElementById('uid');
    const routeSel = document.getElementById('route');
    const shareBtn = document.getElementById('shareBtn');
    const waitBtn = document.getElementById('waitBtn');
    const scheduleList = document.getElementById('scheduleList');
    const clearTrailBtn = document.getElementById('clearTrail');

    // Map init
    const map = L.map('map', { zoomControl:true, preferCanvas:true });
    const defaultPos = { lat: -7.135742, lng: -34.845412 }; // UFPB - Sede João Pessoa
    map.setView(defaultPos, 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap' }).addTo(map);

    // Layers and state
    const busLayer = L.layerGroup().addTo(map);     // only bus main marker(s)
    const waitLayer = L.layerGroup().addTo(map);    // wait requests
    const trailLayer = L.layerGroup().addTo(map);   // polylines
    let busPolyline = L.polyline([], { color: '#0ea5e9', weight: 5, opacity: 0.95 }).addTo(map);
    let busMarker = null;
    const latestPingByUid = new Map(); // avoid many markers: keep latest ping per uid if needed
    const waitMarkersById = new Map();

    // Basic schedules (use your full schedule)
    const schedules = [
      { route: 'Interno', time: '06:40', note:'DUAS VOLTAS APENAS DENTRO DA SEDE' },
      { route: 'Intercampi', time: '07:20', note:'SAINDO DO CCHLA(SEDE) PARA O CI/CTDR' },
      { route: 'Intercampi', time: '08:00', note:'SAINDO DO CI/CTDR PARA O CCHLA(SEDE) (APENAS UMA VOLTA)' },
      { route: 'Interno', time: '09:20', note:'DUAS VOLTAS APENAS DENTRO DA SEDE' },
      { route: 'Interno', time: '10:20', note:'DUAS VOLTAS APENAS DENTRO DA SEDE' },
      { route: 'Interno', time: '11:20', note:'DUAS VOLTAS APENAS DENTRO DA SEDE' },
      { route: 'Intercampi', time: '12:20', note:'SAINDO DO CCHLA(SEDE) PARA O CI/CTDR' },
      { route: 'Intercampi', time: '13:00', note:'SAINDO DO CI/CTDR PARA O CCHLA(SEDE) (APENAS UMA VOLTA)' },
      { route: 'Interno', time: '14:20', note:'DUAS VOLTAS APENAS DENTRO DA SEDE' },
      { route: 'Interno', time: '15:20', note:'DUAS VOLTAS APENAS DENTRO DA SEDE' },
      { route: 'Interno', time: '16:20', note:'DUAS VOLTAS APENAS DENTRO DA SEDE' },
      { route: 'Interno', time: '17:20', note:'DUAS VOLTAS APENAS DENTRO DA SEDE' },
      { route: 'Intercampi', time: '18:20', note:'SAINDO DO CCHLA(SEDE) PARA O CI/CTDR' },
      { route: 'Intercampi', time: '19:00', note:'SAINDO DO CI/CTDR PARA O CCHLA(SEDE) (APENAS UMA VOLTA)' },
      { route: 'Interno', time: '20:20', note:'UMA VOLTA APENAS DENTRO DA SEDE' },
      { route: 'Intercampi', time: '21:30', note:'SAINDO DO CCHLA(SEDE) PARA O CI/CTDR' },
      { route: 'Intercampi', time: '22:00', note:'SAINDO DO CI/CTDR PARA O CCHLA(SEDE) (APENAS UMA VOLTA)' }
    ];

    function renderScheduleUI(){
      scheduleList.innerHTML = schedules
        .filter(s => s.route === routeSel.value)
        .map(s => `<li>${s.time} — ${s.note}</li>`).join('');
    }
    renderScheduleUI();
    routeSel.addEventListener('change', ()=> {
      renderScheduleUI();
    });

    // Sidebar toggle
    menuBtn.addEventListener('click', ()=> sidebar.classList.toggle('open'));

    // Auth
    let currentUser = null;
    signBtn.addEventListener('click', async ()=>{
      try{
        await signInWithPopup(auth, provider);
      }catch(e){ alert('Erro login: '+e.message); }
    });

    onAuthStateChanged(auth, user=>{
      currentUser = user;
      statusEl.textContent = user ? 'online' : 'offline';
      uidEl.textContent = user ? (user.displayName || user.email || user.uid.slice(0,6)) : '-';
      if(user && user.photoURL){
        avatarTop.src = user.photoURL; avatarTop.style.display = 'inline-block';
        signBtn.style.display = 'none';
      } else {
        avatarTop.style.display = 'none';
        signBtn.style.display = 'inline-flex';
      }
    });

    // utility: create avatar divIcon
    function avatarIcon(url, size=44){
      const html = `<div class="avatar-marker">${url?`<img src="${url}" alt="avatar"/>`:""}</div>`;
      return L.divIcon({ html, className:'', iconSize:[size,size], iconAnchor:[size/2,size/2] });
    }
    // bus icon DivIcon (nicer)
    function busIcon(){
      const svg = encodeURIComponent(`<svg viewBox="0 0 24 24" width="26" height="26" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="5" width="18" height="11" rx="2" stroke="${encodeURIComponent('#ff9020')}" stroke-width="1.6" fill="#fff"/><circle cx="7" cy="18" r="1.4" fill="${encodeURIComponent('#111')}"/><circle cx="17" cy="18" r="1.4" fill="${encodeURIComponent('#111')}"/></svg>`);
      const html = `<div class="bus-marker"><img src="data:image/svg+xml;utf8,${svg}" style="width:26px;height:26px" /></div>`;
      return L.divIcon({ html, className:'', iconSize:[46,46], iconAnchor:[23,23] });
    }

    // play notification for each new wait request
    function notifyAll(){
      // small visual + sound
      playDing();
    }

    // Write ping to Firestore while sharing as bus
    let shareWatchId = null;
    shareBtn.addEventListener('click', ()=>{
      if(!currentUser){ alert('Faça login com Google antes.'); return; }
      if(shareWatchId === null){
        shareBtn.textContent = 'Parar compartilhamento';
        startSharingAsBus();
      } else {
        shareBtn.textContent = 'Estou no ônibus';
        navigator.geolocation.clearWatch(shareWatchId);
        shareWatchId = null;
      }
    });

    async function startSharingAsBus(){
      if(!('geolocation' in navigator)) { alert('Geolocation não suportada'); return; }
      shareWatchId = navigator.geolocation.watchPosition(async pos=>{
        const { latitude:lat, longitude:lng, accuracy } = pos.coords;
        try{
          await addDoc(collection(db,'bus_pings'), {
            uid: currentUser.uid,
            name: currentUser.displayName || null,
            photoURL: currentUser.photoURL || null,
            route: routeSel.value,
            lat, lng, accuracy,
            ts: serverTimestamp()
          });
        }catch(e){ console.error(e); }
      }, err => console.warn(err), { enableHighAccuracy:true, maximumAge:2000, timeout:15000 });
    }

    // "Estou chegando" (wait request) - uses document id = uid_route to allow updating and single doc per user per route
    let waitWatchId = null;
    waitBtn.addEventListener('click', ()=>{
      if(!currentUser){ alert('Faça login com Google antes.'); return; }
      if(waitWatchId === null){
        waitBtn.textContent = 'Cancelar pedido';
        startWaitRequest();
      } else {
        waitBtn.textContent = 'ESTOU CHEGANDO';
        navigator.geolocation.clearWatch(waitWatchId);
        waitWatchId = null;
        // delete doc immediately
        const id = `${currentUser.uid}_${routeSel.value}`;
        deleteDoc(doc(db,'wait_requests', id)).catch(()=>{});
      }
    });

    async function startWaitRequest(){
      if(!('geolocation' in navigator)) { alert('Geolocation não suportada'); return; }
      const id = `${currentUser.uid}_${routeSel.value}`;
      const ref = doc(db,'wait_requests', id);
      waitWatchId = navigator.geolocation.watchPosition(async pos=>{
        const { latitude:lat, longitude:lng, accuracy } = pos.coords;
        try{
          await setDoc(ref, {
            uid: currentUser.uid,
            name: currentUser.displayName || null,
            photoURL: currentUser.photoURL || null,
            route: routeSel.value,
            lat, lng, accuracy,
            ts: serverTimestamp()
          }, { merge:true });
        }catch(e){ console.error(e); }
      }, err=>console.warn(err), { enableHighAccuracy:true, maximumAge:2000, timeout:15000 });
    }

    // Listen bus_pings -> build trail & latest bus position (group by bus uid? we'll show combined trail for route)
    onSnapshot(query(collection(db,'bus_pings'), orderBy('ts','asc'), limit(1000)), snapshot=>{
      // Build path for selected route only (ordered asc to draw path)
      const pts = [];
      snapshot.docs.forEach(d=>{
        const data = d.data();
        if(data.route !== routeSel.value) return;
        const t = data.ts?.toMillis?.() ?? 0;
        // ignore very old maybe; keep last ~100 pings per route but we limited to 1000
        pts.push([data.lat, data.lng, data]);
      });

      // Build the polyline path exactly where bus passed
      const coords = pts.map(p => [p[0], p[1]]);
      busPolyline.setLatLngs(coords);

      // Set moving bus marker to last coordinate (if exists)
      if(coords.length){
        const last = coords[coords.length - 1];
        if(!busMarker) {
          busMarker = L.marker(last, { icon: busIcon() }).addTo(busLayer);
        } else {
          busMarker.setLatLng(last);
        }
      } else {
        if(busMarker) { busLayer.removeLayer(busMarker); busMarker = null; }
      }
    });

    // Listen wait_requests -> render one marker per request with avatar, draw dashed line to bus, auto-remove when close
    onSnapshot(query(collection(db,'wait_requests'), orderBy('ts','desc'), limit(200)), snapshot=>{
      // clear existing wait markers/lines & rebuild for route
      for(const [k,v] of waitMarkersById.entries()){ layerRemoveSafe(v.marker); layerRemoveSafe(v.line); }
      waitMarkersById.clear();
      let newRequest = false;
      const cutoff = Date.now() - 1000 * 60 * 15; // 15 min
      snapshot.docs.forEach(d=>{
        const id = d.id;
        const data = d.data();
        if(data.route !== routeSel.value) return;
        const t = data.ts?.toMillis?.() ?? 0;
        if(t < cutoff) return;

        // add marker with avatar and name
        const m = L.marker([data.lat, data.lng], { icon: avatarIcon(data.photoURL || '', 44) })
          .bindPopup(`<b>${escapeHtml(data.name || 'Aluno')}</b><br/>Pedido: Espera eu!`)
          .addTo(waitLayer);

        // draw dashed line to current bus position
        const busLatLngs = busPolyline.getLatLngs();
        if(busLatLngs.length){
          const busPos = busLatLngs[busLatLngs.length - 1];
          const line = L.polyline([[data.lat, data.lng], [busPos.lat, busPos.lng]], { color:'#111', weight:3, dashArray:'8 6', opacity:0.8 }).addTo(waitLayer);
          waitMarkersById.set(id, { marker: m, line });
        } else {
          waitMarkersById.set(id, { marker: m, line: null });
        }

        // detect new (type 'added' could be used, but snapshot doesn't give that here)
        newRequest = true;
      });

      if(newRequest) notifyAll();

      // auto-remove when request close to bus (~30m)
      for(const [id, obj] of waitMarkersById.entries()){
        if(!obj.marker || !busPolyline.getLatLngs().length) continue;
        const p = obj.marker.getLatLng();
        const busPos = busPolyline.getLatLngs().slice(-1)[0];
        if(!busPos) continue;
        const dist = map.distance(p, busPos); // meters
        if(dist < 35){
          // remove request doc
          deleteDoc(doc(db,'wait_requests', id)).catch(()=>{});
          // remove visuals
          layerRemoveSafe(obj.marker); layerRemoveSafe(obj.line);
          waitMarkersById.delete(id);
        }
      }
    });

    // Utility to safely remove layer if exists
    function layerRemoveSafe(layer){
      try{ if(layer && layer.remove) layer.remove(); }catch(e){}
    }

    // Clear trail
    clearTrailBtn.addEventListener('click', ()=>{
      busPolyline.setLatLngs([]);
    });

    // Escape small text for popup safety
    function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // Register service worker for PWA (optional)
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    }

    // simple helper to notify user (visual + sound)
    function notifyAll(){ try{ playDing(); }catch(e){} }

    // small polyfill: ensure routeSel change triggers re-render of layers (force snapshot handlers to use new route)
    routeSel.addEventListener('change', ()=> {
      // force manual refresh by re-subscribing: easiest is to just repaint lists already covered by listeners (they filter by route)
      renderScheduleUI();
    });

    // End of module
  </script>
</body>
</html>
