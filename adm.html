<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Quiz 90s ‚Äî HOST</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- QRCode lib -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <!-- Estilos omitidos aqui (mant√©m os que j√° tinha) -->
</head>
<body>
  <!-- ... seu HTML da tela ... -->

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove, runTransaction, onChildAdded, get } 
      from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDffGKwazMR-P2Bb6459T7IrT_gehEdjwo",
      authDomain: "works-63725.firebaseapp.com",
      projectId: "works-63725",
      databaseURL: "https://works-63725-default-rtdb.firebaseio.com", <!-- esse campo √© essencial -->
      storageBucket: "works-63725.appspot.com",
      messagingSenderId: "314958421674",
      appId: "1:314958421674:web:b5db4802ef3a0375d37ad3",
      measurementId: "G-4V14Z21393"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const quizData = [
      { q:"Qual protocolo popularizou a Internet nos anos 90?", opts:["HTTP","TCP/IP","FTP"], a:1 },
      { q:"Quem criou o primeiro navegador?", opts:["Bill Gates","Tim Berners-Lee","Steve Jobs"], a:1 },
      { q:"Em que ano a Intel lan√ßou o Pentium?", opts:["1993","2000","1989"], a:0 },
      { q:"Qual software de imagem surgiu nos anos 90?", opts:["Photoshop 1.0","Paint 3D","Gimp 2020"], a:0 }
    ];

    let currentIndex=-1;
    const elQ=document.getElementById('question');
    const elOpts=document.getElementById('options');
    const elRes=document.getElementById('results');
    const elRank=document.getElementById('ranking');

    function renderQuestion(){
      const q=quizData[currentIndex];
      elQ.textContent=q.q;
      elOpts.innerHTML='';
      q.opts.forEach((o,idx)=>{
        const div=document.createElement('div');
        div.className='opt';
        div.textContent=`${idx+1}) ${o}`;
        elOpts.appendChild(div);
      });
      elRes.innerHTML='';
    }

    async function loadQuestion(){
      currentIndex = (currentIndex+1) % quizData.length;
      const q=quizData[currentIndex];
      await set(ref(db,'currentQuestion'),{question:q.q,options:q.opts,index:currentIndex,answer:q.a});
      await remove(ref(db,'answers'));
      await set(ref(db,'gameOver'),false);
      renderQuestion();
    }

    document.getElementById('next').onclick=loadQuestion;
    document.getElementById('btn-full').onclick=()=>{
      const r=document.documentElement;
      if(!document.fullscreenElement){ r.requestFullscreen?.() } else { document.exitFullscreen?.() }
    };

    onChildAdded(ref(db,'answers'), async snap=>{
      const ans=snap.val();
      const qSnap=await get(ref(db,'currentQuestion'));
      const curr=qSnap.val();
      if(!curr) return;
      if(ans.qIndex!==curr.index) return;
      if(ans.option===quizData[curr.index].a && ans.player){
        await runTransaction(ref(db,'scores/'+ans.player), val => (val||0)+1 );
      }
      updateBars();
    });

    function updateBars(){
      get(ref(db,'answers')).then(snap=>{
        const data=snap.val()||{}; 
        const vals=Object.values(data);
        const q=quizData[currentIndex];
        const counts=Array(q.opts.length).fill(0);
        vals.forEach(a=>{ if(a.qIndex===currentIndex) counts[a.option]++; });
        const total = Math.max(1, counts.reduce((s,n)=>s+n,0));
        elRes.innerHTML = counts.map((c,idx)=>{
          const pct=((c/total)*100).toFixed(1);
          const correct = idx===q.a;
          return `<div class="bar"><span>${idx+1}) ${q.opts[idx]}</span><div class="track"><div class="fill" style="width:${pct}%"></div></div><span>${pct}%${correct?" ‚úÖ":""}</span></div>`;
        }).join('');
      });
    }

    onValue(ref(db,'scores'), snap=>{
      const data=snap.val()||{};
      const list=Object.entries(data).sort((a,b)=>b[1]-a[1]);
      elRank.innerHTML=list.map(([n,p])=>`<p>${n}: ${p}${p>=4?" üèÜ":""}</p>`).join('') || '<p>Ningu√©m pontuou ainda.</p>';
    });

    const playerUrl = new URL('player.html', location.href).href;
    document.getElementById('game-link').textContent = playerUrl;
    QRCode.toCanvas(document.getElementById('qrcode'), playerUrl, { width: 220 });
  </script>
</body>
</html>
